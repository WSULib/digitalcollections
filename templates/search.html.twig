{% import "macros.html.twig" as m %}
{% extends "base.html.twig" %}

{% block title %}{{ data.id }}{% endblock %}
{% block head %}
    {{ parent() }}
{% endblock %}

{# search form in header #}
{% block search_form_string %}{{search_params.q|escape}}{% endblock search_form_string %}

{% block content %}



<div class="container cached">

	<div class="row">
		<div class="col-md-12" style="margin-top:20px;">			
		</div>
	</div>
    
    <div class="row">

    	<div class="col-md-3">
	    
		    <div id="facets_container" class="facets">

		        <ul class="facet_container filter" id="search_facet">
		            <li>
		                <h3 class="tree-toggler">Search within Results</h3>
		                <ul class="tree facet_list" id="search_facet_box">
		                    <form onsubmit="refineByKeyWord('search','same'); return false;" role="form">
		                        <input id="refine_input" placeholder='Type in word or phrase' class="search-filter">                                                                
								<label class="radio-inline">
									<input type="radio" id="metadata" name="refine_type" value="metadata"> Item Record Only
								</label>
								<label class="radio-inline">
									<input type="radio" id="fulltext" name="refine_type" value="fulltext"> Full-Text Only
								</label>
								<label class="radio-inline">
									<input checked type="radio" id="both" name="refine_type" value="both"> Both
								</label>
		                    </form>
		                </ul>
		            </li>
		        </ul>

		        <!-- ContentModel -->
			    {{ m.facetBlockBuilder(data, query_string, 'Content-Type', 'human_hasContentModel') }}

			    <!-- Collection -->
			    {{ m.facetBlockBuilder(data, query_string, 'Collection', 'human_isMemberOfCollection') }}

			    <!-- MODS Year -->
			    {{ m.facetBlockBuilder(data, query_string, 'Date', 'facet_mods_year') }}

			    <!-- DC Subject -->
			    {{ m.facetBlockBuilder(data, query_string, 'Subject', 'dc_subject') }}

			    <!-- Creator -->
			    {{ m.facetBlockBuilder(data, query_string, 'Creator', 'dc_creator') }}

			    <!-- Coverage -->
			    {{ m.facetBlockBuilder(data, query_string, 'Coverage', 'dc_coverage') }}

			    <!-- Language -->
			    {{ m.facetBlockBuilder(data, query_string, 'Language', 'dc_language') }}

			    <!-- Publisher -->
			    {{ m.facetBlockBuilder(data, query_string, 'Publisher', 'dc_publisher') }}
		        
		    </div>
	    </div> <!-- /facets -->

	    <div id="results" class="col-md-9" style="margin-bottom:10px;">

	    	<div id="facet_modal" class="row" style="display:none;">
	    		<div class="col-md-12">

	    			<!-- facets modal -->
	    			<div class="row" style="background-color: rgba(255, 219, 116, 0.3); padding-top: 15px; margin-bottom: 20px; border-radius:5px;">
	    				<div class="col-md-12">
	    					<h2>Refine by: <span id="facet_label" style="font-weight:bold;"></span></h2>
    					</div>
    					<div class="col-md-12">
			    			<table id="facet_modal_table" class="table stripe">
			    				<thead>
			    					<tr>
			    						<th>Facet Value</th>
			    						<th>Facet Count</th>
		    						</tr>
								</thead>
								<tbody></tbody>
		    				</table>
	    				</div>
	    				<div class="col-md-12">
		    				<p><button type="btn" class="btn btn-sm" style="border: 1px solid #8c8c8c;" onclick="facet_select(null, null, true); return false;">Cancel</button></p>	    				
	    				</div>
	    			</div>
    			</div>
			</div>

			<div id="non_modal">

		    	<div id="results_header" class="row row-fluid filtered-by refined-by" style="background-color: rgba(255, 219, 116, 0.3); padding-top: 15px; margin-bottom: 20px; border-radius:5px;">

		    		<div class="row">

			    		<div class="col-md-4">
			    			<h2 style="margin-top:0px;"><span style="font-weight:bold;" id='num_results'>{{ data.response.solr_results.response.numFound|number_format }}</span> Results</h2>
		    			</div>

		    			<div class="col-md-8" style="float:right; text-align:right;">
							<span style="font-weight:bold; display:inline-block;">Results per Page</span>
					    	<div style="display:inline-block; padding-right:10px; margin-bottom:0px;" class="form-group">
					    		<select id="results_per_page" class="resPerPage form-control" name="results_per_page">
					    			{# <label for="results_per_page">Results per Page</label> #}
					        		<option {% if search_params.rows == 10 %}selected{% endif %} value=10>10</option>
					        		<option {% if search_params.rows == 20 %}selected{% endif %} value=20>20</option>
					        		<option {% if search_params.rows == 50 %}selected{% endif %} value=50>50</option>
					        		<option {% if search_params.rows == 100 %}selected{% endif %} value=100>100</option>
					    		</select>
							</div>
							<span style="font-weight:bold; display:inline-block; padding-right:10px;">Layout</span> <a href="{{path_for('search') ~ "?" ~ set_layout_param(QueryBuilder, 'list', query_string)}}">List <i class="icon-list4"></i></a> | <a href="{{path_for('search') ~ "?" ~ set_layout_param(QueryBuilder, 'grid', query_string)}}">Grid <i class="icon-layout"></i></a> | <a href="#" onclick="toggleFacets(); return false;">Facets <i class="icon-eye"></i></a>
						</div>

					</div>

					{% if search_params.q != '' %}
						<div class="row">
							<div class="col-md-12">
								{% if search_params.field_skip_escape %}
									<p><strong>Boolean Searching:</strong> <span style="font-style:italic;">{{search_params.q|escape}}</span></p>
								{% else %}
									<p><strong>Searching:</strong> <span style="font-style:italic;">{{search_params.q|escape}}</span></p>
								{% endif %}
							</div>
						</div>
					{% endif %}

					{% if search_params.fq|length > 0 %}
					<div class="row">
						<div class="col-md-12" style="margin-bottom:20px;">
							<p style="margin-top:0px; margin-bottom:0px;"><strong>Refined by:</strong></p>
							{% for fq in search_params.fq %}
					    		<span class="facet-item"><a href="{{path_for('search') ~ "?" ~ del_param_from_query_string(QueryBuilder, fq, query_string, true)}}"><i class="icon-delete"></i> <span class="facet_name">{{ facet_map[fq|split(":")[0]] }}</span>: {{ fq|split(":")|slice(1,3)|join(":") }}</a></span>
					        {% endfor %}
				        </div>
			        </div>
			        {% endif %}


				</div>
		    	
		        <!-- results -->
		        <div class="row">
		        	<div class="col-md-12" style="padding-left:0px;">
				        <ul class="row-fluid objects-container" id="results_container">

				        	<!-- list -->
				        	{% if search_params.layout == 'list' %}
				        		{% for doc in data.response.solr_results.response.docs %}
					        	<li class="obj-cnt object-container-list">
								    <div class="crop">
								        <a href="/item/{{doc.id}}">
								        	{% if doc.rels_preferredContentModel.0 != 'info:fedora/CM:Container' %}
						                		<img style="box-shadow: 2px 2px 3px rgba(0,0,0,0.4); max-height: 195px; margin-right:3px;" src="/item/{{doc.id}}/thumbnail" width="100%" alt="{{doc.dc_title.0}}">
					                		{% else %}
					                			<img src="/item/{{doc.id}}/thumbnail" width="100%" alt="{{doc.dc_title.0}}">
				                			{% endif %}								        	
								        </a>
								    </div>
								    <h3>
								        <a href="/item/{{doc.id}}">{{doc.dc_title[0]}}<br> </a>
								    </h3>								    
								    <h4></h4>
								    <p class="truncate" style="margin:0px;">{{(doc.dc_description[0]|length > 500 ? doc.dc_description[0]|slice(0, 500) ~ '&hellip;' : doc.dc_description[0])|raw}}</p>    
								</li>
								{% endfor %}
							{% endif %}

							<!-- grid -->
							{% if search_params.layout == 'grid' %}
								{% for doc in data.response.solr_results.response.docs %}
									<div class='tile' style="box-shadow: 2px 2px 3px rgba(0,0,0,0.4); border: 3px solid white; border:none;">
										<a href="/item/{{doc.id}}">		
											<img src="/item/{{doc.id}}/thumbnail" width='100%' alt="{{doc.dc_title.0}}" />
											{# <div class="info">
												<p>{{doc.dc_title[0]}}</p>						
											</div> #}
										</a>
									</div>
								{% endfor %}
							{% endif %}

							<!-- facets -->
							{% if search_params.hide_facets == 'true' %}
								<script>
									$(document).ready(function(){
										toggleFacets();
									});
								</script>
							{% endif %}

			        	</ul>
					</div>
				</div>

			</div>

			<!-- pagination row -->
		    <div class="row">
		    	<div class="col-md-12">

			        <!-- pagination -->
			        <div class="pagination-centered"></div>

		        </div>
		    </div>

		</div> <!-- close right side -->

	</div> 

</div> <!-- /container -->


<script>

	/* ############################################### */
	/* Move these to another JS file during JS cleanup */
	/* ############################################### */

	/////////////////////////////////////////////////////
	// update pagination
	/////////////////////////////////////////////////////
	$(document).ready(function(){
		
		var spage = parseInt({{search_params.start}} / {{search_params.rows}}) + 1;
		if (spage == 0) {
			spage = 1;
		}
		
		$('.pagination-centered').bootpag({
			 total: tpagesPaginate({{data.response.solr_results.response.numFound}}, {{search_params.rows}}),
			 page: spage,
			 maxVisible: 8,
			 leaps:false
		}).on('page', function(event, num){         
				var nURL = updateURLParameter(window.location.href, "start", ((num * {{search_params.rows}}) - {{search_params.rows}}) );
				// refresh page 
			window.location = nURL;
		});
	});

	function tpagesPaginate(results, rows){
		var tpage_dec = results / rows;
		if (tpage_dec % 1 != 0){
			return parseInt(tpage_dec) + 1
		}
		else {
			return tpage_dec
		}
	}


	/////////////////////////////////////////////////////
	// update results per page
	/////////////////////////////////////////////////////
	$(document).ready(function(){
		
		// monitor for change
		$(".resPerPage").change(function() {    
			var nURL = window.location.href;    
			new_rows = $(this).val();
			nURL = updateURLParameter(nURL, 'rows', new_rows); 
			// adjust start pointer
			if (new_rows > {{search_params.start}}){    
				nURL = updateURLParameter(nURL, 'start', "0");
			} 
			// refresh page 
			window.location = nURL;
		});  
	});


	/////////////////////////////////////////////////////
	// init grid freewall code
	/////////////////////////////////////////////////////
	gridInit();


	/////////////////////////////////////////////////////
	// toggle facets
	/////////////////////////////////////////////////////
	$(document).ready(function(){
		
		var facet_check = getUrlParameter('facets');

		if (facet_check == 'true') {
			toggleFacets();
		}

	});

	function toggleFacets(){	

		$("#facets_container").toggle();
		$("#results").toggleClass('col-md-9').toggleClass('col-md-12');
		facetLayoutRefresh();
	}

	function facetLayoutRefresh(){
		var wall = new freewall("#results_container");
		wall.refresh();	
		window.dispatchEvent(new Event('resize'));
	}

	function getUrlParameter(sParam) {
	    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
	        sURLVariables = sPageURL.split('&'),
	        sParameterName,
	        i;

	    for (i = 0; i < sURLVariables.length; i++) {
	        sParameterName = sURLVariables[i].split('=');

	        if (sParameterName[0] === sParam) {
	            return sParameterName[1] === undefined ? true : sParameterName[1];
	        }
	    }
	};

	/////////////////////////////////////////////////////
	// select facets
	/////////////////////////////////////////////////////
	function facet_select(facet_id, facet_name, close_facet_sel=false, toggle_view=true){

		if (close_facet_sel != true ){

			// if not already set, prep and build table
			if (!$("#facet_modal").attr('current_facet_id') || $("#facet_modal").attr('current_facet_id') != facet_id ){

				// set toggling flag
				var old_facet_id = $("#facet_modal").attr('current_facet_id');		
				var current_vis = $("#facet_modal").css('display');
				if ( current_vis != 'none' && old_facet_id != undefined && old_facet_id != facet_id ) {
					toggle_view = false;
				}				
				
				// add facet_id as attr, in case return to immediately, don't reload data
				$("#facet_modal").attr('current_facet_id',facet_id);

				// update facet label
				$("#facet_label").html(facet_name);

				// build and prep table
				facet_query_url = '/api/search?{{ query_string|raw }}&facet.limit=-1&facet.field=' + facet_id;
				console.log(facet_query_url);
			    $('#facet_modal_table').DataTable({
			    	"ajax": {
						"url": facet_query_url,
						"dataSrc": 'response.solr_results.facet_counts.facet_fields.' + facet_id,					
					},
					"columns": [
						{
							"data": 0,
							"render": function ( data, type, row, meta ) {
								return add_facet(facet_id, data);
							}
						},
						{
							"data": 1,
							"render": function ( data, type, row, meta ) {
								// return add_facet(facet_id, data);
								return data
							}
						}
					],
					"order": [[1,'desc']],
					"lengthMenu": [[10, 20, 50, -1], [10, 20, 50, "All"]],
					"pageLength":20,
					"destroy":true, // destroys table each time
		    	});
			}	
		}		

		// after table built, or if returning to pre-built table, show
		if (toggle_view) {
			$("#non_modal").toggle();
			$("#facet_modal").toggle();	
		}

		// always scroll to top
		$("html").scrollTop(0);
		
	}

	function add_facet(facet_id, facet_value){		

		// build new URL
		encoded_facet_value = encodeURIComponent(facet_value).replace(/%20/g, '+').replace(/\(/g,'%28').replace(/\)/g,'%29');
		new_url = '/search?{{query_string|raw}}'+'&fq%5B%5D='+facet_id+'%3A'+encoded_facet_value;

		// return
		return '<a href="'+ new_url +'">'+ facet_value +'</a>';

	}

</script>


{% endblock %}























